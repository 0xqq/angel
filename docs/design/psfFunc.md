# psFunc (ParameterServer Func)

作为标准的参数服务器，正常都会提供基本的参数**获取（pull）**和**更新（push）**功能。但实际应用中，各个算法对参数服务器上的参数获取和更新，却远远不只这么简单，尤其是当算法需要实施一些特定的优化的时候。

> 举个例子，有时候某些算法，要得到`矩阵模型`中某一行的最大值，如果PS系统，只有基本的Pull接口，那么PSClient，就只能先将该行的所有列，都从参数服务器上拉取回来，然后在Worker上计算得到最大值，这样会产生很多的网络通信开销，对性能会有影响。而如果我们有一个自定义函数，每个PSServer在远程先计算出n个局部最大值，再交换确认全局最大值，这时只要返回1个数值就可以了，这样的方式，计算开销接近，但通信开销将大大降低。


为了解决类似的问题，Angel引入和实现psFunc的概念，对远程模型的获取和更新的流程进行了封装和抽象。它也是一种用户自定义函数（UDF），但都和PS操作密切相关的，因此被成为**psFunc**，简称**psf**，整体架构如下：

![](../img/angel_psFunc.png)

随着psFunc的引入，模型的计算，也会发生在PSServer端。PSServer也将有一定的模型计算职责，而不是单纯的模型存储功能。合理的设计psFunc，将大大的加速算法的运行。

值得一提的是，伴随着psFunc的引入和强化，在很多复杂的算法实现中，降低了Worker要把模型完整的拖回来进行整体计算的可能性，从而曲线的实现了**模型并行**。

## 实现流程

psFunc的实现，都有固定的步骤，具体如下：

* **参数获取**

	1. **请求划分**
		
		参数服务器的接口，操作的是**整个模型参数**。而模型参数是被划分成多个分区存储在不同的PS实例中的，因此在请求阶段，就要进行划分了
		
		* PS Client（参数服务器客户端）进行请求划分，生成一个请求列表，这个请求列表中，**每一个请求都和一个模型参数分区对应**
	
	2. **请求发送** 
		* Angel将请求列表中的所有请求，发送给模型参数分区所在的PS实例。
		* PS实例以模型参数分区为单位执行参数获取和更新操作，并返回相应的结果。

	3. **结果合并**
		*  合并所有的模型分区级结果，得到最终的结果并返回

*  **参数更新**

	1. PS Client（参数服务器客户端）进行请求划分，生成一个请求列表，这个请求列表中的每一个请求都和一个模型参数分区对应。

	2. 将请求列表中的所有请求发送给模型参数分区所在的PS实例。PS实例以模型参数分区为单位执行参数获取和更新操作，并返回相应的结果。

	3. 等待所有请求完成后返回

## 分类

整体上，Angel的psFunc分成两大类，一类是获取型，一类是更新型

* [GetFunc(获取类函数)](psf_get.md)
* [UpdateFunc(更新类函数)](psf_update.md)
